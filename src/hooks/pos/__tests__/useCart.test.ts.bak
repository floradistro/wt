import { renderHook, act } from '@testing-library/react-native'
import { useCart } from '../useCart'
import type { Product, PricingTier } from '@/types/pos'

describe('useCart', () => {
  const mockProduct: Product = {
    id: 'product-1',
    name: 'Test Product',
    regular_price: 10.00,
    inventory_quantity: 100,
    category: 'Test',
    inventory_id: 'inv-1'
  } as Product

  it('should initialize with an empty cart', () => {
    const { result } = renderHook(() => useCart())
    
    expect(result.current.cart).toEqual([])
    expect(result.current.itemCount).toBe(0)
    expect(result.current.subtotal).toBe(0)
  })

  it('should add product to cart', () => {
    const { result } = renderHook(() => useCart())
    
    act(() => {
      result.current.addToCart(mockProduct)
    })

    expect(result.current.cart).toHaveLength(1)
    expect(result.current.cart[0]).toMatchObject({
      name: 'Test Product',
      price: 10.00,
      quantity: 1,
    })
    expect(result.current.itemCount).toBe(1)
    expect(result.current.subtotal).toBe(10.00)
  })

  it('should increment quantity when adding same product', () => {
    const { result } = renderHook(() => useCart())
    
    act(() => {
      result.current.addToCart(mockProduct)
      result.current.addToCart(mockProduct)
    })

    expect(result.current.cart).toHaveLength(1)
    expect(result.current.cart[0].quantity).toBe(2)
    expect(result.current.itemCount).toBe(2)
    expect(result.current.subtotal).toBe(20.00)
  })

  it('should update quantity', () => {
    const { result } = renderHook(() => useCart())
    
    act(() => {
      result.current.addToCart(mockProduct)
    })

    const productId = result.current.cart[0].id

    act(() => {
      result.current.updateQuantity(productId, 1)
    })

    expect(result.current.cart[0].quantity).toBe(2)
    expect(result.current.subtotal).toBe(20.00)
  })

  it('should remove item when quantity reaches 0', () => {
    const { result } = renderHook(() => useCart())
    
    act(() => {
      result.current.addToCart(mockProduct)
    })

    const productId = result.current.cart[0].id

    act(() => {
      result.current.updateQuantity(productId, -1)
    })

    expect(result.current.cart).toHaveLength(0)
    expect(result.current.subtotal).toBe(0)
  })

  it('should clear cart', () => {
    const { result } = renderHook(() => useCart())
    
    act(() => {
      result.current.addToCart(mockProduct)
      result.current.addToCart(mockProduct)
    })

    act(() => {
      result.current.clearCart()
    })

    expect(result.current.cart).toHaveLength(0)
    expect(result.current.itemCount).toBe(0)
    expect(result.current.subtotal).toBe(0)
  })

  it('should handle pricing tiers', () => {
    const { result } = renderHook(() => useCart())
    const tier: PricingTier = {
      weight: '3.5g',
      price: 25.00,
      label: '3.5g'
    }
    
    act(() => {
      result.current.addToCart(mockProduct, tier)
    })

    expect(result.current.cart[0]).toMatchObject({
      name: 'Test Product (3.5g)',
      price: 25.00,
      quantity: 1,
      tierLabel: '3.5g'
    })
    expect(result.current.subtotal).toBe(25.00)
  })
})
